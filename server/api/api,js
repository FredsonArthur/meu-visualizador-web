// Simula a importa√ß√£o das fun√ß√µes de gerenciamento de dados do "backend"
const { 
    getAllCollections, 
    getLinksByCollection, 
    createLink,
    deleteLink, 
    updateLink,
    searchLinks,
    toggleLinkReadStatus // ‚¨ÖÔ∏è NOVO: Importamos a nova fun√ß√£o
} = require('../../server/api/linkManager'); 

// ----------------------------------------------------
// UTILS DE SIMULA√á√ÉO
// ----------------------------------------------------

/**
 * Simula um delay de rede (100ms a 500ms)
 */
const simulateNetworkDelay = () => {
    // Atraso de 100ms a 500ms para simular lat√™ncia de rede
    const delay = Math.random() * 400 + 100; 
    return new Promise(resolve => setTimeout(resolve, delay));
};

/**
 * Constr√≥i um objeto de resposta simulado, semelhante ao Fetch API
 */
const mockResponse = (data, status = 200) => ({
    status: status,
    ok: status >= 200 && status < 300,
    // Fun√ß√£o para ler o corpo (dados) de forma ass√≠ncrona
    json: async () => data, 
    // Fun√ß√£o para ler o corpo como texto
    text: async () => JSON.stringify(data),
});


// ----------------------------------------------------
// ROTAS MOCK (Substituindo as chamadas diretas)
// ----------------------------------------------------

/**
 * üìö GET /api/collections
 * Retorna todas as cole√ß√µes.
 */
async function apiGetCollections() {
    await simulateNetworkDelay();
    try {
        const collections = getAllCollections();
        return mockResponse(collections, 200);
    } catch (error) {
        return mockResponse({ message: 'Erro ao buscar cole√ß√µes' }, 500);
    }
}

/**
 * üîó GET /api/links/:collectionId
 * Retorna os links de uma cole√ß√£o ou todos.
 */
async function apiGetLinks(collectionId) {
    await simulateNetworkDelay();
    try {
        const links = getLinksByCollection(collectionId);
        return mockResponse(links, 200);
    } catch (error) {
        return mockResponse({ message: 'Erro ao buscar links' }, 500);
    }
}

/**
 * ‚ûï POST /api/links
 * Cria um novo link.
 */
async function apiCreateLink(linkData) {
    // N√£o simula delay aqui, pois o delay j√° est√° dentro do createLink (scraper)
    try {
        const newLink = await createLink(linkData); // createLink j√° √© async
        return mockResponse(newLink, 201); // 201 Created
    } catch (error) {
        return mockResponse({ message: 'Erro ao criar link' }, 500);
    }
}

/**
 * üóëÔ∏è DELETE /api/links/:linkId
 * Exclui um link.
 */
async function apiDeleteLink(linkId) {
    await simulateNetworkDelay();
    try {
        const success = deleteLink(linkId);
        if (success) {
            return mockResponse(null, 204); // 204 No Content (Sucesso, sem corpo)
        }
        return mockResponse({ message: 'Link n√£o encontrado' }, 404);
    } catch (error) {
        return mockResponse({ message: 'Erro ao excluir link' }, 500);
    }
}

/**
 * ‚úèÔ∏è PUT /api/links/:linkId
 * Atualiza um link existente.
 */
async function apiUpdateLink(linkId, newData) {
    await simulateNetworkDelay();
    try {
        const success = updateLink(linkId, newData);
        if (success) {
            return mockResponse({ message: 'Link atualizado com sucesso' }, 200);
        }
        return mockResponse({ message: 'Link n√£o encontrado' }, 404);
    } catch (error) {
        console.error("Erro na API (Atualiza√ß√£o):", error);
        return mockResponse({ message: 'Erro ao atualizar link' }, 500);
    }
}

/**
 * üîé GET /api/search?q=:query
 * Busca links.
 */
async function apiSearchLinks(query) {
    await simulateNetworkDelay();
    try {
        const results = searchLinks(query);
        return mockResponse(results, 200);
    } catch (error) {
        return mockResponse({ message: 'Erro ao buscar links' }, 500);
    }
}

/**
 * üîÑ PUT /api/links/:linkId/toggle-read (NOVA ROTA)
 * Alterna o status 'lido' de um link.
 */
async function apiToggleReadStatus(linkId) {
    await simulateNetworkDelay(); // Simula o delay de rede
    try {
        const success = toggleLinkReadStatus(linkId);
        if (success) {
            return mockResponse({ message: 'Status atualizado' }, 200);
        }
        return mockResponse({ message: 'Link n√£o encontrado' }, 404);
    } catch (error) {
        return mockResponse({ message: 'Erro ao alternar status' }, 500);
    }
}


// Exporta todas as rotas simuladas para serem usadas pelo Front-end (home.js)
module.exports = {
    apiGetCollections,
    apiGetLinks,
    apiCreateLink,
    apiDeleteLink,
    apiUpdateLink,
    apiSearchLinks,
    apiToggleReadStatus // ‚¨ÖÔ∏è NOVO: Exportamos o toggle read
};